---
import { getCollection, type CollectionEntry } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import TableOfContents from "../../components/content/TableOfContents.astro";
import ViewCounter from "../../components/blog/ViewCounter";
import Quote from "../../components/content/Quote.astro";
import Link from "../../components/content/Link.astro";

export async function getStaticPaths() {
    const posts = await getCollection("blog", ({ data }) => {
        return import.meta.env.PROD ? data.status === "published" : true;
    });
    return posts.map((post) => ({
        params: { slug: post.slug },
        props: { post },
    }));
}

interface Props {
    post: CollectionEntry<"blog">;
}

const { post } = Astro.props;
const { Content, headings } = await post.render();

const allPosts = await getCollection("blog", ({ data }) => {
    return import.meta.env.PROD ? data.status === "published" : true;
});
const sortedPosts = allPosts.sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

const currentIndex = sortedPosts.findIndex((p) => p.slug === post.slug);

const previousPost =
    currentIndex < sortedPosts.length - 1
        ? sortedPosts[currentIndex + 1]
        : null;
const nextPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : null;

const publishedDate = post.data.pubDate.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
});

const updatedDate = post.data.updatedDate
    ? post.data.updatedDate.toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
      })
    : null;
---

<Layout
    title={post.data.title}
    description={post.data.description}
    image={post.data.image || post.data.heroImage?.src}
    article={true}
    publishedTime={post.data.pubDate}
    modifiedTime={post.data.updatedDate}
>
    <div class="w-full mx-auto py-12 sm:py-24">
        <!-- Main Content Grid - TOC aligned with content -->
        <div
            class="max-w-[83rem] mx-auto px-4 sm:px-6 lg:grid lg:grid-cols-[1fr_minmax(0,_2.5fr)_1fr] lg:gap-8"
        >
            <!-- Left Sidebar - Table of Contents -->
            <div class="lg:col-start-1">
                <TableOfContents headings={headings} />
            </div>

            <!-- Main Column -->
            <div class="lg:col-start-2">
                <!-- Title Section -->
                <header class="mb-10">
                    <h1
                        class="text-3xl font-semibold tracking-tight mb-6 text-flexoki-tx"
                        style="text-wrap: balance;"
                        transition:name={`blog-card-${post.slug}`}
                        transition:animate="fade"
                    >
                        {post.data.title}
                    </h1>

                    {
                        post.data.description && (
                            <p class="text-base leading-7 mb-6 text-flexoki-tx-2" style="text-wrap: pretty;">
                                {post.data.description}
                            </p>
                        )
                    }

                    <!-- Metadata -->
                    <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-flexoki-tx-3">
                        <time datetime={post.data.pubDate.toISOString()}>
                            {publishedDate}
                        </time>
                        {
                            updatedDate && (
                                <span class="text-flexoki-tx-3">
                                    · Updated {updatedDate}
                                </span>
                            )
                        }
                        <span class="text-flexoki-tx-3">·</span>
                        <ViewCounter
                            slug={post.slug}
                            increment={true}
                            client:only="react"
                        />
                        {
                            post.data.tags && post.data.tags.length > 0 && (
                                <>
                                    <span class="text-flexoki-tx-3">·</span>
                                    <div class="flex flex-wrap gap-1.5">
                                        {post.data.tags.slice(0, 3).map((tag) => (
                                            <span class="text-flexoki-tx-3">
                                                #{tag}
                                            </span>
                                        ))}
                                    </div>
                                </>
                            )
                        }
                    </div>
                </header>

                <!-- Hero Image -->
                {
                    post.data.heroImage && (
                        <div
                            class="mb-12"
                            transition:name={`blog-hero-${post.slug}`}
                            transition:animate="fade"
                        >
                            <div class="relative w-full aspect-[2/1] rounded-lg overflow-hidden bg-muted border border-flexoki-ui">
                                <img
                                    src={post.data.heroImage.src}
                                    alt={post.data.heroImage.alt}
                                    class="object-cover w-full h-full"
                                />
                            </div>
                        </div>
                    )
                }

                <!-- Article Content -->
                <article class="blog-content">
                    <div
                        class:list={[
                            "prose prose-flexoki max-w-none",
                            "prose-headings:text-flexoki-tx prose-headings:font-semibold prose-headings:scroll-mt-10",
                            "prose-h2:text-base prose-h2:mt-14 prose-h2:mb-4 prose-h2:tracking-tight",
                            "prose-h3:text-base prose-h3:mt-10 prose-h3:mb-3 prose-h3:font-medium",
                            "prose-p:text-flexoki-tx-2 prose-p:text-base prose-p:leading-7 prose-p:[text-wrap:pretty]",
                            "prose-a:text-flexoki-tx-2 prose-a:underline prose-a:decoration-flexoki-tx-3/50 prose-a:underline-offset-2 prose-a:decoration-1 prose-a:hover:text-flexoki-tx prose-a:hover:decoration-flexoki-tx prose-a:transition-colors",
                            "prose-strong:text-flexoki-tx/90 prose-strong:font-medium",
                            "prose-li:text-flexoki-tx-2 prose-li:leading-relaxed",
                            "prose-li:marker:text-flexoki-tx-3",
                            "prose-ul:my-4 prose-ul:space-y-2",
                            "prose-ol:my-4 prose-ol:space-y-2",
                            "prose-code:before:content-none prose-code:after:content-none",
                            "prose-table:text-flexoki-tx prose-table:border-flexoki-ui prose-table:border prose-table:rounded-lg",
                            "prose-tr:border-flexoki-ui prose-tr:border-b",
                            "prose-td:border-flexoki-ui prose-td:border-r",
                            "prose-td:p-2 prose-td:text-flexoki-tx-2",
                            "prose-th:p-2 prose-th:text-flexoki-tx",
                            "prose-img:rounded-xl prose-img:border-flexoki-ui/50 prose-img:border",
                            "prose-blockquote:border-none prose-blockquote:not-italic prose-blockquote:p-0 prose-blockquote:m-0",
                            "prose-hr:border-flexoki-ui/50 prose-hr:my-12",
                            "dark:prose-invert",
                        ]}
                    >
                        <Content components={{ blockquote: Quote, a: Link }} />
                    </div>
                </article>
            </div>

            <!-- Right Sidebar (empty for balance) -->
            <div class="lg:col-start-3"></div>
        </div>

        <!-- Navigation Footer -->
        <div class="max-w-3xl mx-auto px-4 sm:px-6 mt-20 pt-8 border-t border-flexoki-ui/50">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Previous Post -->
                <div>
                    {
                        previousPost ? (
                            <a
                                href={`/blog/${previousPost.slug}`}
                                class="group block"
                            >
                                <span class="text-xs text-flexoki-tx-3 uppercase tracking-wider">
                                    ← Previous
                                </span>
                                <h4 class="mt-2 text-flexoki-tx-2 group-hover:text-flexoki-tx transition-colors leading-snug">
                                    {previousPost.data.title}
                                </h4>
                            </a>
                        ) : (
                            <div>
                                <span class="text-xs text-flexoki-tx-3 uppercase tracking-wider">
                                    ← Previous
                                </span>
                                <p class="mt-2 text-sm text-flexoki-tx-3">
                                    You've reached the beginning
                                </p>
                            </div>
                        )
                    }
                </div>

                <!-- Next Post -->
                <div class="md:text-right">
                    {
                        nextPost ? (
                            <a
                                href={`/blog/${nextPost.slug}`}
                                class="group block"
                            >
                                <span class="text-xs text-flexoki-tx-3 uppercase tracking-wider">
                                    Next →
                                </span>
                                <h4 class="mt-2 text-flexoki-tx-2 group-hover:text-flexoki-tx transition-colors leading-snug">
                                    {nextPost.data.title}
                                </h4>
                            </a>
                        ) : (
                            <div>
                                <span class="text-xs text-flexoki-tx-3 uppercase tracking-wider">
                                    Next →
                                </span>
                                <p class="mt-2 text-sm text-flexoki-tx-3">
                                    You're up to date
                                </p>
                            </div>
                        )
                    }
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-20 max-w-3xl mx-auto px-4 sm:px-6">
            <p class="text-sm text-flexoki-tx-3/60">
                © {new Date().getFullYear()} Railly Hugo ·{" "}
                <a
                    href="https://x.com/raillyhugo"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="underline decoration-flexoki-tx-3/30 underline-offset-2 hover:text-flexoki-tx-2 hover:decoration-flexoki-tx-3/50 transition-colors"
                >
                    X
                </a>{" "}·{" "}
                <a
                    href="https://github.com/railly"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="underline decoration-flexoki-tx-3/30 underline-offset-2 hover:text-flexoki-tx-2 hover:decoration-flexoki-tx-3/50 transition-colors"
                >
                    GitHub
                </a>{" "}·{" "}
                <a
                    href="https://linkedin.com/in/raillyhugo"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="underline decoration-flexoki-tx-3/30 underline-offset-2 hover:text-flexoki-tx-2 hover:decoration-flexoki-tx-3/50 transition-colors"
                >
                    LinkedIn
                </a>
            </p>
        </footer>
    </div>

    <style>
        :target {
            scroll-margin-top: 2.5rem;
        }

        .blog-content :global(h2),
        .blog-content :global(h3) {
            scroll-margin-top: 2.5rem;
        }

        .blog-content :global(h2:target),
        .blog-content :global(h3:target) {
            scroll-margin-top: 2.5rem;
        }

        .blog-content :global(p + p) {
            margin-top: 1rem;
        }

        .blog-content :global(h2 + p),
        .blog-content :global(h3 + p) {
            margin-top: 0;
        }

        /* Inline code only (not code inside pre blocks) */
        .blog-content :global(:not(pre) > code) {
            background-color: var(--color-flexoki-bg-2);
            padding: 0.125rem 0.375rem;
            font-size: 0.875rem;
            border-radius: 0.25rem;
            color: var(--color-flexoki-tx);
        }
    </style>
</Layout>
