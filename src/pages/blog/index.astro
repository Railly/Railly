---
import { getCollection } from "astro:content";
import PremiereCountdown from "../../components/blog/PremiereCountdown";
import { isPostListable } from "../../config/blog";
import Layout from "../../layouts/Layout.astro";

const posts = await getCollection("blog", ({ data }) => {
	return import.meta.env.PROD ? isPostListable(data) : true;
});

const sortedPosts = posts.sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

const postsByYear = sortedPosts.reduce(
	(acc, post) => {
		const year = post.data.pubDate.getFullYear();
		if (!acc[year]) acc[year] = [];
		acc[year].push(post);
		return acc;
	},
	{} as Record<number, typeof sortedPosts>,
);

const years = Object.keys(postsByYear)
	.map(Number)
	.sort((a, b) => b - a);

const newestPost = sortedPosts[0];
const isNewest = (slug: string) => slug === newestPost?.slug;

const formatDate = (date: Date) => {
	const day = date.getDate().toString().padStart(2, "0");
	const month = (date.getMonth() + 1).toString().padStart(2, "0");
	return `${day}/${month}`;
};
---

<Layout
    title="Blog - Railly Hugo"
    description="Technical articles, tutorials, and thoughts on web development, AI, and building in public."
>
  <main class="max-w-2xl mx-auto px-6 py-12">
    <h1 class="text-3xl font-medium text-flexoki-tx mb-12">Writing</h1>
    <div class="space-y-1">
      {
        years.map((year) => (
          <>
            {postsByYear[year].map((post, index) => {
              const isPremiere = post.data.status === "premiere" && new Date() < post.data.pubDate;
              const Element = isPremiere ? "div" : "a";
              return (
                <Element
                  {...(!isPremiere ? { href: `/blog/${post.slug}` } : {})}
                  class:list={[
                    "group flex items-baseline gap-4 py-3 border-b border-flexoki-ui transition-colors -mx-3 px-3",
                    isPremiere ? "cursor-default" : "hover:bg-flexoki-bg-2",
                  ]}
                >
                  <span class="text-flexoki-tx-3 tabular-nums w-12 shrink-0 text-sm">
                    {index === 0 ? year : ""}
                  </span>
                  <span class:list={[
                    "flex-1 font-medium text-sm",
                    isPremiere ? "text-flexoki-tx-3" : "text-flexoki-tx group-hover:text-flexoki-tx",
                  ]}>
                    {post.data.title}
                    {isPremiere ? (
                      <span class="ml-2 text-xs font-normal px-1.5 py-0.5 border border-flexoki-ui rounded text-flexoki-tx-3">
                        Premiere
                      </span>
                    ) : isNewest(post.slug) ? (
                      <span class="ml-2 text-xs font-normal px-1.5 py-0.5 bg-flexoki-ui rounded text-flexoki-tx-2">
                        Newest
                      </span>
                    ) : null}
                  </span>
                  {isPremiere ? (
                    <PremiereCountdown pubDate={post.data.pubDate.toISOString()} client:only="react" />
                  ) : (
                    <span class="text-flexoki-tx-3 tabular-nums text-sm shrink-0">
                      {formatDate(post.data.pubDate)}
                    </span>
                  )}
                </Element>
              );
            })}
          </>
        ))
      }
    </div>
  </main>
</Layout>
