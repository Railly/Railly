---
import { getCollection } from "astro:content";
import Layout from "../layouts/Layout.astro";
import PageLayout from "../components/layout/PageLayout.astro";
import SectionHeader from "../components/layout/SectionHeader.astro";
import BlogCard from "../components/ui/BlogCard.astro";
import Footer from "../components/layout/Footer.astro";

const allPosts = await getCollection("blog", ({ data }) => {
    return import.meta.env.PROD ? data.status !== "draft" : true;
});

const activePosts = allPosts
    .filter(({ data }) => data.status === "published")
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const archivedPosts = allPosts
    .filter(({ data }) => data.status === "archived")
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<Layout>
    <PageLayout class="flex flex-col gap-8">
        <div class="flex items-center justify-between">
                    <SectionHeader title="Writing" className="mb-0" />
                    {
                        archivedPosts.length > 0 && (
                            <archive-toggle>
                                <button class="group text-xs text-flexoki-tx-3 hover:text-flexoki-tx-2 transition-colors duration-200">
                                    <span class="flex items-center gap-1">
                                        <span>archive</span>
                                        <svg
                                            width="10"
                                            height="10"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            class="archive-icon transition-transform duration-200"
                                        >
                                            <polyline points="6 9 12 15 18 9" />
                                        </svg>
                                    </span>
                                </button>
                            </archive-toggle>
                        )
                    }
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {
                        activePosts.map((post) => (
                            <BlogCard
                                href={`/blog/${post.slug}`}
                                target="_self"
                                color="purple"
                                title={post.data.title}
                                image={post.data.image}
                                imageDark={post.data.imageDark}
                                date={post.data.pubDate.toLocaleDateString(
                                    "en-US",
                                    {
                                        year: "numeric",
                                        month: "long",
                                    },
                                )}
                                tag={post.data.tags?.[0]}
                                slug={post.slug}
                            />
                        ))
                    }
                    {
                        activePosts.length === 0 && (
                            <div class="col-span-2 group relative overflow-hidden rounded-lg border border-flexoki-ui transition-all hover:border-flexoki-yellow/30 flex items-center justify-center min-h-[200px]">
                                <div class="absolute inset-0 bg-gradient-to-tr from-flexoki-yellow/[0.03] to-transparent opacity-80 [mask-image:linear-gradient(45deg,#000_25%,transparent_25%,transparent_50%,#000_50%,#000_75%,transparent_75%,transparent)] [mask-size:8px_8px] pointer-events-none" />
                                <div class="relative z-10 text-center p-8">
                                    <div class="mb-3 flex justify-center">
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="24"
                                            height="24"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            class="size-8 fill-flexoki-yellow/50"
                                        >
                                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                                        </svg>
                                    </div>
                                    <h3 class="font-serif text-flexoki-tx font-medium text-lg mb-2">
                                        More stories coming soon
                                    </h3>
                                    <p class="text-sm text-flexoki-tx-2">
                                        Currently crafting new content
                                    </p>
                                </div>
                            </div>
                        )
                    }
                </div>

                {
                    archivedPosts.length > 0 && (
                        <div
                            class="archived-posts hidden mt-8 pt-6 border-t border-flexoki-ui/30"
                        >
                            <p class="text-xs text-flexoki-tx-3 mb-4 font-mono">
                                Older writings â€” kept for reference
                            </p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 opacity-60">
                                {archivedPosts.map((post) => (
                                    <BlogCard
                                        href={`/blog/${post.slug}`}
                                        target="_self"
                                        color="purple"
                                        title={post.data.title}
                                        image={post.data.image}
                                        imageDark={post.data.imageDark}
                                        date={post.data.pubDate.toLocaleDateString(
                                            "en-US",
                                            {
                                                year: "numeric",
                                                month: "long",
                                            },
                                        )}
                                        tag={post.data.tags?.[0]}
                                        slug={post.slug}
                                    />
                                ))}
                            </div>
                </div>
            )
        }
        <Footer />
    </PageLayout>
</Layout>

<script>
    class ArchiveToggle extends HTMLElement {
        connectedCallback() {
            const button = this.querySelector('button');
            const icon = this.querySelector('.archive-icon');
            const archivedSection = document.querySelector('.archived-posts');

            if (button && icon && archivedSection) {
                button.addEventListener('click', () => {
                    const isHidden = archivedSection.classList.contains('hidden');

                    if (isHidden) {
                        archivedSection.classList.remove('hidden');
                        icon.classList.add('rotate-180');
                    } else {
                        archivedSection.classList.add('hidden');
                        icon.classList.remove('rotate-180');
                    }
                });
            }
        }
    }

    customElements.define('archive-toggle', ArchiveToggle);
</script>
