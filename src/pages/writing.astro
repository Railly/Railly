---
import { getCollection } from "astro:content";
import PremiereCountdown from "../components/blog/PremiereCountdown";
import ViewCounter from "../components/blog/ViewCounter";
import Footer from "../components/layout/Footer.astro";
import PageLayout from "../components/layout/PageLayout.astro";
import SectionHeader from "../components/layout/SectionHeader.astro";
import { isPostListable } from "../config/blog";
import Layout from "../layouts/Layout.astro";

const ogTitle = "Writing";
const ogDescription = "Articles on design engineering, context engineering, AI tools, and building in public.";
const ogImage = `/api/og?title=${encodeURIComponent(ogTitle)}&description=${encodeURIComponent(ogDescription)}`;

const allPosts = await getCollection("blog", ({ data }) => {
	return import.meta.env.PROD ? data.status !== "draft" : true;
});

const activePosts = allPosts
	.filter(({ data }) => isPostListable(data))
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const archivedPosts = allPosts
	.filter(({ data }) => data.status === "archived")
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const postsByYear = activePosts.reduce(
	(acc, post) => {
		const year = post.data.pubDate.getFullYear();
		if (!acc[year]) acc[year] = [];
		acc[year].push(post);
		return acc;
	},
	{} as Record<number, typeof activePosts>,
);

const archivedByYear = archivedPosts.reduce(
	(acc, post) => {
		const year = post.data.pubDate.getFullYear();
		if (!acc[year]) acc[year] = [];
		acc[year].push(post);
		return acc;
	},
	{} as Record<number, typeof archivedPosts>,
);

const years = Object.keys(postsByYear)
	.map(Number)
	.sort((a, b) => b - a);

const archivedYears = Object.keys(archivedByYear)
	.map(Number)
	.sort((a, b) => b - a);

const newestPost = activePosts[0];
const isNewest = (slug: string) => slug === newestPost?.slug;

const formatDate = (date: Date) => {
	const day = date.getDate().toString().padStart(2, "0");
	const month = (date.getMonth() + 1).toString().padStart(2, "0");
	return `${day}/${month}`;
};
---

<Layout
    title="Writing - Railly Hugo"
    description={ogDescription}
    image={ogImage}
>
    <PageLayout class="flex flex-col gap-8">
        <div class="flex items-center justify-between">
            <SectionHeader title="Writing" className="mb-0" />
            {
                archivedPosts.length > 0 && (
                    <archive-toggle>
                        <button class="group text-xs text-flexoki-tx-3 hover:text-flexoki-tx-2 transition-colors duration-200">
                            <span class="flex items-center gap-1">
                                <span>archive</span>
                                <svg
                                    width="10"
                                    height="10"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    class="archive-icon transition-transform duration-200"
                                >
                                    <polyline points="6 9 12 15 18 9" />
                                </svg>
                            </span>
                        </button>
                    </archive-toggle>
                )
            }
        </div>

        <div class="space-y-0">
            {
                years.map((year) => (
                    <>
                        {postsByYear[year].map((post, index) => {
                            const isPremiere = post.data.status === "premiere" && new Date() < post.data.pubDate;
                            const Element = isPremiere ? "div" : "a";
                            return (
                                <Element
                                    {...(!isPremiere ? { href: `/blog/${post.slug}` } : {})}
                                    class:list={[
                                        "group flex items-baseline gap-4 py-3 border-b border-flexoki-ui transition-colors -mx-3 px-3",
                                        isPremiere ? "cursor-default" : "hover:bg-flexoki-bg-2",
                                    ]}
                                >
                                    <span class="text-flexoki-tx-3 tabular-nums w-12 shrink-0 text-sm">
                                        {index === 0 ? year : ""}
                                    </span>
                                    <span class:list={[
                                        "flex-1 font-medium text-sm",
                                        isPremiere ? "text-flexoki-tx-3" : "text-flexoki-tx group-hover:text-flexoki-tx",
                                    ]}>
                                        {post.data.title}
                                        {isPremiere ? (
                                            <span class="ml-2 text-xs font-normal px-1.5 py-0.5 border border-flexoki-ui rounded text-flexoki-tx-3">
                                                Premiere
                                            </span>
                                        ) : isNewest(post.slug) ? (
                                            <span class="ml-2 text-xs font-normal px-1.5 py-0.5 bg-flexoki-ui rounded text-flexoki-tx-2">
                                                Newest
                                            </span>
                                        ) : null}
                                    </span>
                                    {isPremiere ? (
                                        <PremiereCountdown pubDate={post.data.pubDate.toISOString()} client:only="react" />
                                    ) : (
                                        <>
                                            <ViewCounter
                                                slug={post.slug}
                                                client:only="react"
                                                className="text-xs text-flexoki-tx-3 tabular-nums shrink-0"
                                            />
                                            <span class="text-flexoki-tx-3 tabular-nums text-sm shrink-0">
                                                {formatDate(post.data.pubDate)}
                                            </span>
                                        </>
                                    )}
                                </Element>
                            );
                        })}
                    </>
                ))
            }
            {
                activePosts.length === 0 && (
                    <div class="py-12 text-center">
                        <p class="text-flexoki-tx-2">More stories coming soon</p>
                    </div>
                )
            }
        </div>

        {
            archivedPosts.length > 0 && (
                <div class="archived-posts hidden mt-4 pt-6 border-t border-flexoki-ui/30">
                    <p class="text-xs text-flexoki-tx-3 mb-4 font-mono">
                        Older writings â€” kept for reference
                    </p>
                    <div class="space-y-0 opacity-60">
                        {archivedYears.map((year) => (
                            <>
                                {archivedByYear[year].map((post, index) => (
                                    <a
                                        href={`/blog/${post.slug}`}
                                        class="group flex items-baseline gap-4 py-3 border-b border-flexoki-ui hover:bg-flexoki-bg-2 transition-colors -mx-3 px-3"
                                    >
                                        <span class="text-flexoki-tx-3 tabular-nums w-12 shrink-0 text-sm">
                                            {index === 0 ? year : ""}
                                        </span>
                                        <span class="flex-1 text-flexoki-tx group-hover:text-flexoki-tx font-medium text-sm">
                                            {post.data.title}
                                        </span>
                                        <span class="text-flexoki-tx-3 tabular-nums text-sm shrink-0">
                                            {formatDate(post.data.pubDate)}
                                        </span>
                                    </a>
                                ))}
                            </>
                        ))}
                    </div>
                </div>
            )
        }
        <Footer />
    </PageLayout>
</Layout>

<script>
    class ArchiveToggle extends HTMLElement {
        connectedCallback() {
            const button = this.querySelector('button');
            const icon = this.querySelector('.archive-icon');
            const archivedSection = document.querySelector('.archived-posts');

            if (button && icon && archivedSection) {
                button.addEventListener('click', () => {
                    const isHidden = archivedSection.classList.contains('hidden');

                    if (isHidden) {
                        archivedSection.classList.remove('hidden');
                        icon.classList.add('rotate-180');
                    } else {
                        archivedSection.classList.add('hidden');
                        icon.classList.remove('rotate-180');
                    }
                });
            }
        }
    }

    customElements.define('archive-toggle', ArchiveToggle);
</script>
