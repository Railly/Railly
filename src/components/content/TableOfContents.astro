---
interface Props {
	headings: { depth: number; slug: string; text: string }[];
}

const { headings } = Astro.props;

const mainHeadings = headings.filter((heading) => heading.depth <= 3);
---

<nav class="sticky top-24 w-64 hidden lg:block">
    <a
        href="/writing"
        class="flex items-center gap-1.5 text-sm mb-6 text-flexoki-tx-2 hover:text-flexoki-tx transition-colors duration-200"
    >
        <svg
            width="16"
            height="16"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            viewBox="0 0 24 24"
            stroke-linecap="round"
            stroke-linejoin="round"
            xmlns="http://www.w3.org/2000/svg"
            class="rotate-180"
        >
            <path d="M4.5 12h15m0 0-5.625-6m5.625 6-5.625 6"></path>
        </svg>
        <span>writing</span>
    </a>

    <ul class="space-y-0.5 text-sm border-l border-flexoki-ui">
        {
            mainHeadings.map((heading) => (
                <li class={heading.depth === 3 ? "ml-3" : ""}>
                    <a
                        href={`#${heading.slug}`}
                        class="toc-link block py-1 px-3 text-sm border-l-2 -ml-px transition-all duration-200 border-transparent text-flexoki-tx-2 hover:text-flexoki-tx hover:border-flexoki-ui-2"
                        data-heading={heading.slug}
                    >
                        <span class="line-clamp-2">{heading.text}</span>
                    </a>
                </li>
            ))
        }
    </ul>
</nav>

<nav class="sticky top-24 w-64 block lg:hidden">
    <a
        href="/writing"
        class="flex items-center gap-1.5 text-sm mb-6 text-flexoki-tx-2 hover:text-flexoki-tx transition-colors duration-200"
    >
        <svg
            width="16"
            height="16"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            viewBox="0 0 24 24"
            stroke-linecap="round"
            stroke-linejoin="round"
            xmlns="http://www.w3.org/2000/svg"
            class="rotate-180"
        >
            <path d="M4.5 12h15m0 0-5.625-6m5.625 6-5.625 6"></path>
        </svg>
        <span>writing</span>
    </a>
</nav>

<script>
    function setupTableOfContents() {
        const toc = document.querySelector("nav.hidden.lg\\:block");
        if (!toc) return;

        const tocLinks = toc.querySelectorAll(".toc-link");
        const sections = Array.from(tocLinks)
            .map((link) => {
                const slug = link.getAttribute("data-heading");
                return slug ? document.getElementById(slug) : null;
            })
            .filter(Boolean);

        const observerOptions = {
            rootMargin: "-100px 0px -66% 0px",
            threshold: 0,
        };

        const intersectionCallback = (entries: IntersectionObserverEntry[]) => {
            entries.forEach((entry) => {
                const slug = entry.target.id;
                const link = toc.querySelector(`[data-heading="${slug}"]`);

                if (entry.isIntersecting) {
                    tocLinks.forEach((l) => {
                        l.classList.remove(
                            "border-flexoki-tx",
                            "text-flexoki-tx",
                            "font-medium",
                        );
                        l.classList.add(
                            "border-transparent",
                            "text-flexoki-tx-2",
                        );
                    });
                    link?.classList.remove(
                        "border-transparent",
                        "text-flexoki-tx-2",
                    );
                    link?.classList.add(
                        "border-flexoki-tx",
                        "text-flexoki-tx",
                        "font-medium",
                    );
                }
            });
        };

        const observer = new IntersectionObserver(
            intersectionCallback,
            observerOptions,
        );
        sections.forEach((section) => section && observer.observe(section));

        return () => {
            sections.forEach(
                (section) => section && observer.unobserve(section),
            );
            observer.disconnect();
        };
    }

    setupTableOfContents();

    document.addEventListener("astro:page-load", setupTableOfContents);
</script>
