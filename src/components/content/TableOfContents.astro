---
interface Props {
    headings: { depth: number; slug: string; text: string }[];
}

const { headings } = Astro.props;

const mainHeadings = headings.filter((heading) => heading.depth <= 3);
---

<nav
    class="sticky top-24 w-64 hidden lg:block opacity-65 hover:opacity-100 transition-opacity duration-300"
>
    <a
        href="/writing"
        class="flex items-center gap-1.5 text-sm mb-6 text-flexoki-tx-2 hover:text-flexoki-tx transition-colors duration-200"
    >
        <svg
            width="16"
            height="16"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            viewBox="0 0 24 24"
            stroke-linecap="round"
            stroke-linejoin="round"
            xmlns="http://www.w3.org/2000/svg"
            class="rotate-180"
        >
            <path d="M4.5 12h15m0 0-5.625-6m5.625 6-5.625 6"></path>
        </svg>
        <span>writing</span>
    </a>

    <ul class="space-y-0.5 text-sm border-l border-flexoki-ui">
        {
            mainHeadings.map((heading) => (
                <li class={heading.depth === 3 ? "ml-3" : ""}>
                    <a
                        href={`#${heading.slug}`}
                        class="toc-link block py-1 px-3 text-sm border-l-2 -ml-px transition-all duration-200 border-transparent text-flexoki-tx-2 hover:text-flexoki-tx hover:border-flexoki-ui-2"
                        data-heading={heading.slug}
                    >
                        <span class="line-clamp-2">{heading.text}</span>
                    </a>
                </li>
            ))
        }
    </ul>
</nav>

<nav class="sticky top-24 w-64 block lg:hidden">
    <a
        href="/writing"
        class="flex items-center gap-1.5 text-sm mb-6 text-flexoki-tx-2 hover:text-flexoki-tx transition-colors duration-200"
    >
        <svg
            width="16"
            height="16"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            viewBox="0 0 24 24"
            stroke-linecap="round"
            stroke-linejoin="round"
            xmlns="http://www.w3.org/2000/svg"
            class="rotate-180"
        >
            <path d="M4.5 12h15m0 0-5.625-6m5.625 6-5.625 6"></path>
        </svg>
        <span>writing</span>
    </a>
</nav>

<script>
    function setupTableOfContents() {
        const toc = document.querySelector("nav.hidden.lg\\:block");
        if (!toc) return;

        const navEl = toc as HTMLElement;
        let scrollHandler: (() => void) | null = null;

        scrollHandler = () => {
            if (window.scrollY > 50) {
                navEl.classList.remove("opacity-65");
                navEl.classList.add("opacity-30");
            } else {
                navEl.classList.remove("opacity-30");
                navEl.classList.add("opacity-65");
            }
        };
        window.addEventListener("scroll", scrollHandler, { passive: true });

        const tocLinks = toc.querySelectorAll(".toc-link");
        const sections = Array.from(tocLinks)
            .map((link) => {
                const slug = link.getAttribute("data-heading");
                return slug ? document.getElementById(slug) : null;
            })
            .filter((s): s is HTMLElement => s !== null);

        let currentActive: Element | null = null;

        function setActiveLink(link: Element | null) {
            if (currentActive === link) return;

            if (currentActive) {
                currentActive.classList.remove(
                    "border-flexoki-tx",
                    "text-flexoki-tx",
                    "font-medium",
                );
                currentActive.classList.add(
                    "border-transparent",
                    "text-flexoki-tx-2",
                );
            }

            if (link) {
                link.classList.remove(
                    "border-transparent",
                    "text-flexoki-tx-2",
                );
                link.classList.add(
                    "border-flexoki-tx",
                    "text-flexoki-tx",
                    "font-medium",
                );
            }

            currentActive = link;
        }

        tocLinks.forEach((link) => {
            link.addEventListener("click", (e) => {
                e.preventDefault();
                const slug = link.getAttribute("data-heading");
                const target = slug ? document.getElementById(slug) : null;
                if (target) {
                    target.scrollIntoView({
                        behavior: "smooth",
                        block: "start",
                    });
                    setActiveLink(link);
                    history.pushState(null, "", `#${slug}`);
                }
            });
        });

        const observerOptions = {
            rootMargin: "-80px 0px -70% 0px",
            threshold: 0,
        };

        const intersectionCallback = (entries: IntersectionObserverEntry[]) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting) {
                    const slug = entry.target.id;
                    const link = toc.querySelector(`[data-heading="${slug}"]`);
                    setActiveLink(link);
                }
            });
        };

        const observer = new IntersectionObserver(
            intersectionCallback,
            observerOptions,
        );
        sections.forEach((section) => observer.observe(section));

        if (sections.length > 0 && !window.location.hash) {
            const firstLink = toc.querySelector(".toc-link");
            setActiveLink(firstLink);
        } else if (window.location.hash) {
            const slug = window.location.hash.slice(1);
            const link = toc.querySelector(`[data-heading="${slug}"]`);
            setActiveLink(link);
        }

        return () => {
            sections.forEach((section) => observer.unobserve(section));
            observer.disconnect();
            if (scrollHandler)
                window.removeEventListener("scroll", scrollHandler);
        };
    }

    setupTableOfContents();
    document.addEventListener("astro:page-load", setupTableOfContents);
</script>
