---
interface Props {
  embedId: string;
  embedSrc: string;
  embedType: "youtube" | "linkedin" | "linkedin-link" | "image";
  linkedinUrl?: string;
  imageUrl?: string;
  embedDescription?: string;
}

const { embedId, embedSrc, embedType, linkedinUrl, imageUrl, embedDescription } = Astro.props;
---

{embedType === "image" ? (
  <div
    id={embedId}
    class="py-4 w-full overflow-hidden rounded-md embed-container hidden transition-all duration-300 max-h-0 opacity-0"
  >
    <div class="relative rounded-lg overflow-hidden border border-flexoki-ui group/image aspect-video bg-flexoki-bg-2">
      <img
        src={imageUrl}
        alt="Achievement preview"
        class="w-full h-full object-cover"
        loading="eager"
      />
      {/* Center external link button */}
      <a
        href="https://www.linkedin.com/posts/railly-hugo_de-vuelta-en-lima-despu%C3%A9s-de-una-experiencia-activity-7369217715481362432-XgLj"
        target="_blank"
        rel="noopener noreferrer"
        class="absolute inset-0 flex items-center justify-center cursor-pointer"
        aria-label="View full post on LinkedIn"
      >
        <svg class="size-10 stroke-white" fill="none" viewBox="0 0 24 24" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"/>
        </svg>
      </a>
      {/* Top gradient overlay with title */}
      <div class="absolute inset-x-0 top-0 bg-gradient-to-b from-black/80 via-black/40 to-transparent pt-3 pb-20 px-3 select-none pointer-events-none">
        <p class="text-white font-medium leading-relaxed !my-0 line-clamp-1">
          ðŸ‡¨ðŸ‡´âœ¨ De vuelta en Lima despuÃ©s de una experiencia brutal en la <span class="font-bold">IA Hackathon del Colombia Tech Fest</span>
        </p>
      </div>
      {/* Bottom gradient overlay with LinkedIn link */}
      <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent pt-16 pb-3 px-3 pointer-events-none">
        <div class="flex items-end justify-between">
          <div class="select-none pointer-events-none">
            <h4 class="text-white font-semibold">Railly Hugo</h4>
            <p class="text-white/80 text-sm !my-0">design engineer | v0 ambassador | ðŸ‡µðŸ‡ª</p>
          </div>
          <a
            href="https://www.linkedin.com/posts/railly-hugo_de-vuelta-en-lima-despu%C3%A9s-de-una-experiencia-activity-7369217715481362432-XgLj"
            target="_blank"
            rel="noopener noreferrer"
            class="shrink-0 hover:scale-110 transition-transform"
            aria-label="View on LinkedIn"
          >
            <svg class="w-6 h-6 fill-white" viewBox="0 0 24 24">
              <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
            </svg>
          </a>
        </div>
      </div>
    </div>
  </div>
) : embedType === "linkedin-link" ? (
  <div
    id={embedId}
    class="py-4 w-full overflow-hidden rounded-md embed-container hidden transition-all duration-300 max-h-0 opacity-0"
  >
    <a
      href={linkedinUrl}
      target="_blank"
      rel="noopener noreferrer"
      onclick={`window.open('${linkedinUrl}', '_blank'); return false;`}
      class="block bg-gradient-to-br from-flexoki-ui/20 to-flexoki-ui/5 hover:from-flexoki-ui/30 hover:to-flexoki-ui/10 border border-flexoki-ui rounded-lg p-8 transition-all duration-300 group cursor-pointer select-none"
    >
      <div class="flex flex-col items-center gap-4 text-center select-none">
        <div class="flex items-center gap-3">
          <svg class="w-8 h-8 fill-[#0A66C2] pointer-events-none" viewBox="0 0 24 24">
            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
          </svg>
          <span class="text-lg font-medium text-flexoki-tx">View more details</span>
        </div>
        {embedDescription && (
          <p class="text-sm text-flexoki-tx-2 max-w-md">
            {embedDescription}
          </p>
        )}
        <div class="flex items-center gap-2 text-flexoki-tx-3 group-hover:text-[#0A66C2] transition-colors">
          <span class="text-xs font-medium">Learn more</span>
          <svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
          </svg>
        </div>
      </div>
    </a>
  </div>
) : (
  <div
    id={embedId}
    class="py-4 w-full overflow-hidden rounded-md embed-container hidden transition-all duration-300 max-h-0 opacity-0"
    data-embed-src={embedSrc}
    data-embed-type={embedType}
  >
    <!-- Placeholder that will be replaced with the actual iframe when expanded -->
    <div class="loading-placeholder bg-flexoki-ui/10 rounded-md h-[400px] flex items-center justify-center text-flexoki-tx-2">
      <span class="text-sm">Click to load content...</span>
    </div>
  </div>
)}

<script>
  interface EmbedContainer extends HTMLElement {
    dataset: {
      embedSrc?: string;
      embedType?: string;
    };
  }

  // Function to create iframe when needed
  const createIframe = (container: EmbedContainer) => {
    const { embedSrc, embedType } = container.dataset;
    if (!embedSrc || !embedType) return;

    const iframe = document.createElement('iframe');
    iframe.width = '100%';
    iframe.height = '400';
    iframe.src = embedSrc;
    iframe.frameBorder = '0';
    iframe.allowFullscreen = true;

    if (embedType === 'youtube') {
      iframe.title = 'YouTube video';
    } else if (embedType === 'linkedin') {
      iframe.title = 'LinkedIn post';
    }

    // Replace placeholder with iframe
    const placeholder = container.querySelector('.loading-placeholder');
    if (placeholder) {
      container.removeChild(placeholder);
    }
    container.appendChild(iframe);
  };

  // Handle iframe creation when embed is expanded
  // This will be called by the custom element in AchievementCard.astro
  window.addEventListener('achievement-expanded', (event: CustomEvent) => {
    const embedId = event.detail.embedId;
    const container = document.getElementById(embedId) as EmbedContainer;

    if (container) {
      const hasIframe = container.querySelector('iframe');
      const isLinkedInLink = container.querySelector('a[target="_blank"]');

      if (!hasIframe && !isLinkedInLink) {
        createIframe(container);
      }
    }
  });
</script>
