---
import EmbedContainer from "../content/EmbedContainer.astro";
import Card from "./Card.astro";

type ColorName =
	| "blue"
	| "teal"
	| "yellow"
	| "cyan"
	| "purple"
	| "magenta"
	| "orange";

interface Props {
	title: string;
	year: string;
	color: ColorName;
	embedId: string;
	embedSrc: string;
	embedType: "youtube" | "linkedin" | "linkedin-link" | "image";
	project?: string;
	hosts?: string[];
	linkedinUrl?: string;
	imageUrl?: string;
	embedDescription?: string;
	embedTitle?: string;
	scope?: string;
}

const {
	title,
	year,
	color,
	embedId,
	embedSrc,
	embedType,
	project,
	hosts,
	linkedinUrl,
	imageUrl,
	embedDescription,
	embedTitle,
	scope,
} = Astro.props;

// Host mapping for logos and SVGs
const hostMap = {
	vercel: {
		name: "Vercel",
		svgPath: "M37.5274 0L75.0548 65H0L37.5274 0Z",
	},
	midudev: {
		name: "Midudev",
		logo: "/images/midudev-logo.webp",
	},
	unmsm: {
		name: "UNMSM",
		logo: "/images/unmsm-logo.webp",
	},
};
---

<achievement-toggle data-embed-id={embedId}>
    <Card color={color} className="relative cursor-pointer" padding="p-4">
        <div class="flex flex-col gap-2">
            <div class="flex items-start justify-between gap-3">
                <div class="flex items-start gap-2 min-w-0 flex-1">
                    <span class="text-base flex-shrink-0 mt-0.5"
                        >{title.split(" ")[0]}</span
                    >
                    <div class="min-w-0">
                        <h3
                            class="text-sm font-medium text-flexoki-tx leading-tight"
                        >
                            {title.split(" ").slice(1).join(" ")}
                        </h3>
                        <div
                            class="flex flex-wrap items-center gap-x-2 gap-y-0.5 mt-2 text-[11px] font-mono text-flexoki-tx-3"
                        >
                            {
                                hosts && hosts.length > 0 && (
                                    <>
                                        <span>hosted by</span>
                                        <div class="flex items-center gap-1">
                                            {hosts.map((hostKey, index) => {
                                                const host = hostMap[hostKey];
                                                return (
                                                    <>
                                                        <div class="flex items-center gap-0.5">
                                                            {host.svgPath && (
                                                                <svg
                                                                    viewBox="0 0 76 65"
                                                                    fill="none"
                                                                    class="size-2.5"
                                                                >
                                                                    <path
                                                                        d={
                                                                            host.svgPath
                                                                        }
                                                                        fill="currentColor"
                                                                        class="text-flexoki-tx-2"
                                                                    />
                                                                </svg>
                                                            )}
                                                            {host.logo && (
                                                                <img
                                                                    src={
                                                                        host.logo
                                                                    }
                                                                    alt={
                                                                        host.name
                                                                    }
                                                                    class="h-3 w-3"
                                                                />
                                                            )}
                                                            <span class="text-flexoki-tx-2">
                                                                {host.name}
                                                            </span>
                                                        </div>
                                                        {index <
                                                            hosts.length -
                                                                1 && (
                                                            <span>×</span>
                                                        )}
                                                    </>
                                                );
                                            })}
                                        </div>
                                    </>
                                )
                            }
                            {
                                project && (
                                    <>
                                        {hosts && hosts.length > 0 && (
                                            <span>·</span>
                                        )}
                                        <span>project:</span>
                                        <span class="text-flexoki-tx-2">
                                            {project}
                                        </span>
                                    </>
                                )
                            }
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span
                        class="text-[10px] text-flexoki-tx-3 font-mono font-medium px-1.5 py-0.5 rounded border border-flexoki-tx-3/30 flex-shrink-0 flex items-center gap-1"
                    >
                        {scope && <span class="text-sm">{scope}</span>}
                        {year}
                    </span>
                    <div
                        class={`expand-btn size-6 rounded-md bg-flexoki-tx-3/10 hover:bg-flexoki-${color}/20 backdrop-blur-sm flex items-center justify-center text-flexoki-tx-2 hover:text-flexoki-${color} transition-all pointer-events-none`}
                        aria-label="Toggle content"
                        data-target={embedId}
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke-width="2"
                            stroke="currentColor"
                            class="w-3 h-3 expand-icon transition-transform duration-200"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <EmbedContainer
                embedId={embedId}
                embedSrc={embedSrc}
                embedType={embedType}
                linkedinUrl={linkedinUrl}
                imageUrl={imageUrl}
                embedDescription={embedDescription}
                embedTitle={embedTitle}
            />
        </div>
    </Card>
</achievement-toggle>

<script>
    class AchievementToggle extends HTMLElement {
        connectedCallback() {
            const embedId = this.dataset.embedId;
            if (!embedId) return;

            const container = document.getElementById(embedId);
            const icon = this.querySelector(".expand-icon");

            // Click handler for the entire custom element
            this.addEventListener("click", (event) => {
                const target = event.target as HTMLElement;

                // Ignore clicks on links or inside embed containers
                if (target.closest("a") || target.closest(".embed-container")) {
                    return;
                }

                if (container) {
                    const isHidden = container.classList.contains("hidden");

                    if (isHidden) {
                        // Dispatch custom event to create iframe if needed
                        window.dispatchEvent(
                            new CustomEvent("achievement-expanded", {
                                detail: { embedId },
                            }),
                        );

                        // Show embed
                        container.classList.remove("hidden");
                        setTimeout(() => {
                            container.classList.remove("max-h-0", "opacity-0");
                            container.classList.add(
                                "max-h-[600px]",
                                "opacity-100",
                            );
                        }, 10);

                        if (icon) {
                            icon.classList.add("rotate-180");
                        }
                    } else {
                        // Hide embed
                        container.classList.add("max-h-0", "opacity-0");
                        container.classList.remove(
                            "max-h-[600px]",
                            "opacity-100",
                        );

                        setTimeout(() => {
                            container.classList.add("hidden");
                        }, 300);

                        if (icon) {
                            icon.classList.remove("rotate-180");
                        }
                    }
                }
            });
        }
    }

    customElements.define("achievement-toggle", AchievementToggle);
</script>
